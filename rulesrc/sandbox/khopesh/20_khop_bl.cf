# From Adam Katz (khopesh) testing grounds and live channels
# http://khopesh.com/Anti-spam

### select rules from khop-bl
# (warren's work has already covered most of what I'd add here)

# Detect milter-greylist, scam-grey, postgrey, SQLgrey, and hopefully others
header	 __GREYLISTING	ALL =~ /^X-(?:Scam-Grey|Greylist(?:ing)?):\s/m
header	 __GREYLISTED	ALL =~ /^X-(?:Scam-grey|Greylist(?:ing)?): [Dd]elay(?:ed)? (?:for )?\d+(?: ?s(?:ec(?:ond)?s?)?|:\d\d)/

meta KHOP_GREYED __GREYLISTED && (RDNS_NONE || RDNS_DYNAMIC || __HELO_NO_DOMAIN)
describe KHOP_GREYED	Greylisted and sent from dynamically-named relay
score	 KHOP_GREYED	0.1

header	 __DKIM_EXISTS	exists:DKIM-Signature
ifplugin Mail::SpamAssassin::Plugin::DKIM
  meta	   DKIM_INVALID	__DKIM_EXISTS&&!(DKIM_SIGNED||DKIM_VALID||DKIM_VERIFIED)
  describe DKIM_INVALID	DKIM-Signature header exists but is not valid
endif

ifplugin Mail::SpamAssassin::Plugin::SPF
# ifplugin Mail::SpamAssassin::Plugin::DKIM
    meta   __NOT_SPOOFED	ALL_TRUSTED || SPF_PASS || DKIM_VERIFIED
# else
#   meta   __NOT_SPOOFED	ALL_TRUSTED || SPF_PASS
# endif
else
# ifplugin Mail::SpamAssassin::Plugin::DKIM
    meta   __NOT_SPOOFED	ALL_TRUSTED || DKIM_VERIFIED
# else
#   # Neither DKIM nor SPF ... ugh.  Approximate by looking for just the header.
#   header __DKIM_EXISTS        exists:DKIM-Signature
#   meta   __NOT_SPOOFED       ALL_TRUSTED || __DKIM_EXISTS
# endif
endif
tflags	   __NOT_SPOOFED	nice
