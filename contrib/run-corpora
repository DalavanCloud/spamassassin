#!/bin/sh

# <@LICENSE>
# Copyright 2004 Apache Software Foundation
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# </@LICENSE>
#
# This is a small script used to interact with run-masses to do a full
# corpus mass-check run, including the rsync to the SA server.
# Change the appropriate variables below.
#
# By default, it'll do a set0 run, but you can change that by adding
# --net or --bayes to the commandline.
#
# --net by itself will automatically try running 4 mass-checks in parallel
#

PATH=/bin:/usr/bin:/usr/local/bin
export PATH

CORPUS=/home/felicity/SA/corpus
SA_VER=$HOME/SA/spamassassin-corpora
SVN=svn
SVNVERS=svnversion
WGET=wget

NET=0
BAYES=0
OPTS=""
RSYNC_USER=YOURUSERNAME
RSYNC_PASSWORD="YOURPASSWORD"; export RSYNC_PASSWORD
VERS=nightly
FILENAME=$RSYNC_USER
umask 002

while [ ! -z "$1" ]; do
  if [ "$1" = "--net" ]; then
    NET=1
  elif [ "$1" = "--bayes" ]; then
    BAYES=1
  fi
  shift
done

if [ $NET -eq 1 ]; then
  FILENAME="net-$FILENAME"
  OPTS="$OPTS --net --reuse"
  AFTER="-60 days"
  VERS=weekly

  # We want to do this with more parallelization, but not if Bayes is also running ...
  if [ $BAYES -eq 0 ]; then
    OPTS="$OPTS -j 4"
  fi
else
  AFTER="-120 days"
fi

if [ $BAYES -eq 1 ]; then
  FILENAME="bayes-$FILENAME"
  OPTS="$OPTS --bayes"
else
  OPTS="$OPTS -n"
fi

cd $HOME/Obsolete
if [ -f ham.log -o -f spam.log ]; then
  echo "A previous run still has log files, exiting." >&2
  exit 2
fi

rm -f ham.log spam.log results.log


# Update SA version before our run
echo "[Updating $SA_VER]"
cd $SA_VER
COUNT=0
while ! $WGET -q -nd -m http://rsync.spamassassin.org/$VERS-versions.txt ; do
  sleep 60
  COUNT=`expr $COUNT + 1`
  if [ $COUNT -gt 5 ]; then
    echo "Couldn't get the $VERS revision version, aborting!" >&2
    exit 2
  fi
done

CREV=`$SVNVERS . | awk -F: '{print $1}'`
NREV=`tail -1 $VERS-versions.txt | awk '{print $2}'`

if [ $CREV -ge $NREV ]; then
  echo "Current rev ($CREV) newer or equal to nightly rev ($NREV)"
  exit 0
fi

# blow away the last generated rules dir
rm -f rules/*

COUNT=0
while ! $SVN -q update -r $NREV; do
  sleep 60
  COUNT=`expr $COUNT + 1`
  if [ $COUNT -gt 5 ]; then
    echo "Couldn't do a SVN update, aborting!" >&2
    exit 2
  fi
done

# generate the new full rules dir
build/mkrules --out rules > /dev/null

# remove current bayes db set
echo "[Removing old Bayes DB]"
rm -f $SA_VER/masses/spamassassin/bayes*

# do the run
cd $HOME/Obsolete
echo "[Running mass-check '$OPTS' in $CORPUS]"
if [ -z "$AFTER" ]; then
  $CORPUS/run-masses $SA_VER $OPTS > /dev/null
else
  echo "[Using '$AFTER' for --after setting]"
  $CORPUS/run-masses $SA_VER $OPTS --after "$AFTER" > /dev/null
fi

if [ ! -s ham.log -o ! -s spam.log ]; then
	echo "There seems to be a problem with either ham.log or spam.log, aborting!" >&2
	exit 1
fi

mv -f ham.log $CORPUS/results/ham-$FILENAME.log
mv -f spam.log $CORPUS/results/spam-$FILENAME.log
mv -f results.log $CORPUS/results/hf/results-$FILENAME.log

if [ -f ham.log -o -f spam.log ]; then
  echo "There was an error moving files around, aborting!" >&2
  exit 1
fi

# now we have our ham.log and spam.log files...
cd $CORPUS/results
echo "[Uploading daily corpus logs]"
rsync -qPcvuzb *-$FILENAME.log $RSYNC_USER@rsync.spamassassin.org::corpus/

echo "[Our results]"
cat hf/results-$FILENAME.log
