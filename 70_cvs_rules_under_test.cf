# SpamAssassin rules file: CVS rules under test
#
# This file is a placeholder for rules "under probation", ie. checked into
# CVS for testing. It should not be distributed; if the rules have good
# stats after a mass-check or two, then fold them into the distributed
# rules files.
#
# I suggest adding a prefix to rules in this file, "T_" -- this
# helps identify probationary rules in test output.
#
###########################################################################

# should be fixed now
# updated per bug 1217
# %%% INVALID_MSGID
# Dec 17 2002 jm: added subtest since part of my corpus has no msgid
# Dec 17 2002 jm: btw, one FP is for
# <41340.2001:770:18:1:250:4ff:feea:4364.1028136205.squirrel@webmail.heanet.ie>,
# ie an IPv6 address in the msgid.  Not sure if that's interesting or not ;)

# Dec 24 2002 jm: ok, I think we should drop these... not really getting
# around the FPs

header __VALID_MSGID MESSAGEID =~ /^<(?:[a-zA-Z0-9.,!\#\$%&'*\+\/=?\^_{}|~-]+|\".+\")\@(?:[a-zA-Z0-9_.-]+|\[\d{1,3}(?:\.\d{1,3}){3}\])>(?:\s*\(.*\))?\s*$/m [if-unset: <NO@MSGID>]
header __HAS_MSGID		MESSAGEID =~ /\S/
meta T_INVALID_MSGID		__HAS_MSGID && !__VALID_MSGID
describe T_INVALID_MSGID	Message-Id is not valid, according to RFC 2822
#
# quinlan: If this has a better S/O for others (all of my FPs are from the
# same person), it should be an eval so this can be done properly: strip
# comments on each Message-Id header, then use regular expression.
# Dec 18 2002 jm: S/Os aren't much better for others, but I think we should
# do it that way anyway.
#
header __MSGID_COMMENT		MESSAGEID =~ /\(.*\)/m
meta T_INVALID_MSGID2		__HAS_MSGID && !(__VALID_MSGID || __MSGID_COMMENT)


# these rules may need to factor in ok_languages or ok_locales
# Dec 18 2002 jm: but how? ;)  They are ready to be promoted otherwise
#freqs:  0.084   0.2047   0.0095    0.956   0.84    0.01  T_BODY_UNPRINTABLE
body T_BODY_UNPRINTABLE		/[\x00-\x07\x0b\x0c\x0e-\x1f\x7f]{3,}/
describe T_BODY_UNPRINTABLE	Body includes 3 consecutive unprintable characters
#freqs:  3.660   9.4529   0.0442    0.995   0.96    0.01  T_BODY_8BITS
body T_BODY_8BITS		/[\x80-\xff]{8,}/
describe T_BODY_8BITS		Body includes 8 consecutive 8-bit characters

########################################################################
# bug 1106: forged MUAs
# only needed a \b around the shortest X-Mailer regular expressions

# Mozilla
# Dec 10 2002 jm: dan, you have fps for this, could you check 'em?
header __MOZILLA_MUA		X-Mailer =~ /\bMozilla\b/
header __MOZILLA_MSGID		MESSAGEID =~ /^<[A-F\d]{8}\.[A-F\d]{4,8}\@\S+>$/
meta T_FORGED_MUA_MOZILLA	(__MOZILLA_MUA && !__UNUSABLE_MSGID && !__MOZILLA_MSGID)
describe T_FORGED_MUA_MOZILLA	Forged mail pretending to be from Mozilla
score T_FORGED_MUA_MOZILLA	1.0

# Hmm... maybe possible to use a variant on the check_outlook_timestamp_token
# test for the time component of the MOZILLA rules. - Allen
# Dec 24 2002 jm: probably worth a try.

header __MOZILLA_MSGID2         MESSAGEID =~ /^<[A-F\d]{8}\.[A-F\d]{4,8}\@\S+>$/m
meta T_FORGED_MUA_MOZILLA2      (__MOZILLA_MUA && !__UNUSABLE_MSGID && !__MOZILLA_MSGID2)
describe T_FORGED_MUA_MOZILLA2  Forged mail pretending to be from Mozilla (2)
score T_FORGED_MUA_MOZILLA2     1.0

header __MOZILLA_MSGID3         MESSAGEID =~ /^<[A-F\d]{8}\.[A-F1-9][A-F\d]{0,7}\@\S+>$/m
meta T_FORGED_MUA_MOZILLA3      (__MOZILLA_MUA && !__UNUSABLE_MSGID && !__MOZILLA_MSGID3)
describe T_FORGED_MUA_MOZILLA3  Forged mail pretending to be from Mozilla (3)
score T_FORGED_MUA_MOZILLA3     1.0

########################################################################

# Nov 12 2002 jm: not keen on this.  many ISPs do not provide rDNS these
# days as policy. stupid policy, but there we are. and SpamAssassin policy
# is not to punish users with stupid ISPs...
#
# Dec 20 2002 jm: should make fantastic meta-fodder though. ;)
#
#freqs: 11.817  22.1680   5.3554    0.805   0.53    0.01  T_SENDER_NO_REVERSE
header   T_SENDER_NO_REVERSE    eval:check_for_sender_no_reverse()
describe T_SENDER_NO_REVERSE    No reverse lookup for sender's IP

# test for weird double quoting in the body
body T_BODY_QUOTES_A1	/[\042\222\223\224\262\263\271]{2}\S{0,16}[\042\222\223\224\262\263\271]{2}/
body T_BODY_QUOTES_B1	/[\042\047\222\223\224\262\263\271]{2}\S{0,16}[\042\047\222\223\224\262\263\271]{2}/
body T_BODY_QUOTES_C1	/[\047\222\223\224\262\263\271]{2}\S{0,16}[\047\222\223\224\262\263\271]{2}/
body T_BODY_QUOTES_A2	/(?:[\042\222\223\224\262\263\271]){2}\S{0,16}(?:[\042\222\223\224\262\263\271]){2}/
body T_BODY_QUOTES_B2	/(?:[\042\047\222\223\224\262\263\271]){2}\S{0,16}(?:[\042\047\222\223\224\262\263\271]){2}/
body T_BODY_QUOTES_C2	/(?:[\047\222\223\224\262\263\271]){2}\S{0,16}(?:[\047\222\223\224\262\263\271]){2}/

# small improvement on NORMAL_HTTP_TO_IP
# adds "http://foo@210.192.111.79/" which is used in spam sometimes
uri T_NORMAL_HTTP_TO_IP_1	/^https?\:\/\/(?:\S*\@)?\d+\.\d+\.\d+\.\d+/i
describe T_NORMAL_HTTP_TO_IP_1	Uses a dotted-decimal IP address in URL
uri T_NORMAL_HTTP_TO_IP_2	/^https?\:\/\/(?:[^\/]*\@)?\d+\.\d+\.\d+\.\d+/i
describe T_NORMAL_HTTP_TO_IP_2	Uses a dotted-decimal IP address in URL
uri T_NORMAL_HTTP_TO_IP_3	/^https?\:\/\/[^\/]*\d+\.\d+\.\d+\.\d+/i
describe T_NORMAL_HTTP_TO_IP_3	Uses a dotted-decimal IP address in URL

#bug 1010
body T_CHECK_EMAIL_ISFREE	eval:check_email_isfree()
describe T_CHECK_EMAIL_ISFREE Body contains an e-mail address listed by Email::IsFree

# bug 1014
# from Allen
# 12/20 - Not great, but looks ok, what say ye?  - tvd
# sounds like it's worth something.  maybe combined with from_webmail
# type meta subrule...
# 12/25 - this was looking for T_REPLY_TO_HAS_UNDERLINE_NUMS which got promoted
# we need to be more careful about this kind of stuff. :(
header __FROM_HAS_UNDERLINE_NUMS	From =~ /_\S?(?:[a-z]+\w*?\d+|\d+\w*?[a-z]+)\w*\@/i
meta T_FROM_HAS_UNDERLINE_NUMS		(!REPLY_TO_HAS_UNDERLINE_NUMS && __FROM_HAS_UNDERLINE_NUMS)
describe T_FROM_HAS_UNDERLINE_NUMS	From: contains an underline and numbers/letters

# tvd - 12/25 - part of me says to promote this with strong ham sign, but
# another part says that since it's only 1 person who really gets any hits,
# we shouldn't promote and just let them have local rules.  Thoughts?
# bug 1171
# Listproc - Allen (example: nonspam:<199811090515.AAA28259@chem.harvard.edu>)
# 12/22 - hits a lot for allen (4.3%), a tiny amount for theo (0.05%), and that's it. - tvd
header T_LISTPROC1		X-Listprocessor-version =~ /^\s*(?:\d\.)+\w*\s+--\s+List[Pp]roc(?:essor)?\b/
score T_LISTPROC1		-0.01
tflags T_LISTPROC1		nice

# bug 1010
# tvd - 12/25 - part of me says to promote these with strong spam signs, but
# another part says that since it's only 1 person who gets any hits,
# we shouldn't promote and just let them have local rules.  Thoughts?
#
# 12/22 - 2.59% for quinlan, 0 for others - tvd
uri T_SUPER_BARGAINS_MAILTO	/mailto:\S+[.@]super-bargains\.com/
uri T_SUPER_BARGAINS_URL	/\bsuper-bargains\.com/
# 12/23 - 4.83% for allen, 0 for others - tvd
uri T_KAVKAZCENTER_MAILTO	/mailto:\S+[.@]kavkazcenter\.com/
uri T_KAVKAZCENTER_URL		/\bkavkazcenter\.com/

########################################################################

# bug 1308
# only two rules are needed to effectively subdivide the range
header T_SUSPICIOUS_RECIPS	eval:similar_recipients('0.6','1.2')
header T_VERY_SUSP_RECIPS	eval:similar_recipients('1.2','undef')
describe T_SUSPICIOUS_RECIPS	Similar addresses in recipient list
describe T_VERY_SUSP_RECIPS	Very similar addresses in recipient list 
# another rule based on same idea
header T_SORTED_RECIPS		eval:sorted_recipients()
describe T_SORTED_RECIPS	Recipient list is sorted by address

########################################################################

# 12/25 - tvd - this FPs on Car Talk newsletters, the hit rate is pretty
# low all around (likely to just remove), but let's try a meta exception anyway.
header T_X_BULKMAIL			exists:X-Bulkmail
header __X_BULKMAIL			exists:X-Bulkmail
header __FROM_CARTALK			From =~ /\@cartalk\.com$/
meta T_X_BULKMAIL_2			( __X_BULKMAIL && !__FROM_CARTALK )

# possible additions to NIGERIA rules
body T_SCAM_419_1		/MOHAMMED(?:\.|=2e)?\s?ABACHA/i
body T_SCAM_419_2		/(?:government|bank) of nigeria/i
body T_SCAM_419_3		/nigerian? (?:national|government)/i

# Dec 24 2002 jm: random check
# 12/25 - tvd - great for quinlan (2.69%), hits under .05% for everyone else, no fps
uri T_BARGAIN_URL		/bargains?\.(?:com|biz)/
# 12/25 - tvd - fps a bit for rod, my fp is homestead.com redirect to:
#http://professional.homestead.com/splash.ffhtml?ref=3564&target=www.homestead.com/splash.html%3F3564%26target%3Dwww.hspromos.com/webring.html
uri T_PROMO_URL			/promo(?:tion)?s?\.(?:com|biz)/

