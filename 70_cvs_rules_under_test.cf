# SpamAssassin rules file: CVS rules under test
#
# This file is a placeholder for rules "under probation", ie. checked into
# CVS for testing. It should not be distributed; if the rules have good
# stats after a mass-check or two, then fold them into the distributed
# rules files.
#
# I suggest adding a prefix to rules in this file, "T_" -- this
# helps identify probationary rules in test output.
#
###########################################################################

# should be fixed now
# updated per bug 1217
# %%% INVALID_MSGID
# Dec 17 2002 jm: added subtest since part of my corpus has no msgid
# Dec 17 2002 jm: btw, one FP is for
# <41340.2001:770:18:1:250:4ff:feea:4364.1028136205.squirrel@webmail.heanet.ie>,
# ie an IPv6 address in the msgid.  Not sure if that's interesting or not ;)

# Dec 24 2002 jm: ok, I think we should drop these... not really getting
# around the FPs

header __VALID_MSGID MESSAGEID =~ /^<(?:[a-zA-Z0-9.,!\#\$%&'*\+\/=?\^_{}|~-]+|\".+\")\@(?:[a-zA-Z0-9_.-]+|\[\d{1,3}(?:\.\d{1,3}){3}\])>(?:\s*\(.*\))?\s*$/m [if-unset: <NO@MSGID>]
header __HAS_MSGID		MESSAGEID =~ /\S/
meta T_INVALID_MSGID		__HAS_MSGID && !__VALID_MSGID
describe T_INVALID_MSGID	Message-Id is not valid, according to RFC 2822
#
# quinlan: If this has a better S/O for others (all of my FPs are from the
# same person), it should be an eval so this can be done properly: strip
# comments on each Message-Id header, then use regular expression.
# Dec 18 2002 jm: S/Os aren't much better for others, but I think we should
# do it that way anyway.
#
header __MSGID_COMMENT		MESSAGEID =~ /\(.*\)/m
meta T_INVALID_MSGID2		__HAS_MSGID && !(__VALID_MSGID || __MSGID_COMMENT)

# 12/28 - tvd - The INVALID_MSGID FPs for me are all of these forms:
# <01BC978F.2BBAA120@user@wpi.edu>
# <19990807175443731.AAD379@mail.motherboardx.com@[209.172.141.151]>
# <20021210_@TLZ99369095_@TLZ>
# <20010914114843.SM01072@>
# <110E55CD141679-01@E*Trade_Bank_Mail_Administrator>
# <libSDtMail.9709191456.9353.mcross@rebound/rebound>
# <pid10027.1999.April.29.12:15.830789.@egroups.com>
# In looking at the RFC, the first 3 are invalid (multiple '@' chars).
# The 4th one is invalid because there's nothing after the '@'.
# 5 and 6 are valid. (aka: actual fps)
# 7 is invalid because there is a colon (:) in the id part.
# the two valid fps are because we need the same character set after the @ as we had before it.  'msg-id' is defined
# as dot-atom-text '@' dot-atom-text (not including the folded whitespace or obsolete versions).

header __VALID_MSGID2 MESSAGEID =~ /^<(?:[a-zA-Z0-9.,!\#\$%&'*\+\/=?\^_{}|~-]+|\".+\")\@(?:[a-zA-Z0-9.,!\#\$%&'*\+\/=?\^_{}|~-]+|\[\d{1,3}(?:\.\d{1,3}){3}\])>(?:\s*\(.*\))?\s*$/m [if-unset: <NO@MSGID>]
meta T_INVALID_MSGID3		__HAS_MSGID && !__VALID_MSGID2
meta T_INVALID_MSGID4		__HAS_MSGID && !(__VALID_MSGID2 || __MSGID_COMMENT)

# 12/28 - quinlan - my attempt at interpreting RFC 2822 in such a way
# that we might get a good hit rate.  This is not as picky as the above
# rules, but may have much fewer FPs and still catch all of the really
# bad offenders.  I wish RFC 2822 allowed a smaller set of characters
# here.  The idea here is to not worry about the exact set of special
# characters that are allowed, but to focus on the really bad ones.
#
# quinlan: this is the set of characters that appear in spam, not in
# ham, and are disallowed by RFC 2822
#
# hex	character
# 22      "	note that "foo" is allowed
# 2c      ,	not as common in spam
# 3a      :	note tvd has FPs for this one
# 3b      ;	not as common in spam
# 3c      <	okay at front
# 3e      >	okay at end
# 5c      \
#
header __SANE_MSGID_1	MESSAGEID =~ /^<\S+\@\S+>\s*$/m
header __SANE_MSGID_2	MESSAGEID =~ /^<[^ \t\n\r\x0b\x80-\xff]+\@[^ \t\n\r\x0b\x80-\xff]+>\s*$/m
header __SANE_MSGID_3	MESSAGEID =~ /^<[^<> \t\n\r\x0b\x80-\xff]+\@[^<> \t\n\r\x0b\x80-\xff]+>\s*$/m
header __SANE_MSGID_4	MESSAGEID =~ /^<[^<>\\ \t\n\r\x0b\x80-\xff]+\@[^<>\\ \t\n\r\x0b\x80-\xff]+>\s*$/m
header __SANE_MSGID_5	MESSAGEID =~ /^<[^<>\\,; \t\n\r\x0b\x80-\xff]+\@[^<>\\,; \t\n\r\x0b\x80-\xff]+>\s*$/m
#
header __SPECIAL_MSGID		MESSAGEID =~ /\(.*\)|\".*\"/m
#
meta T_INVALID_MSGID5		__HAS_MSGID && !(__SANE_MSGID_1 || __MSGID_COMMENT)
meta T_INVALID_MSGID6		__HAS_MSGID && !(__SANE_MSGID_1 || __SPECIAL_MSGID)
meta T_INVALID_MSGID7		__HAS_MSGID && !(__SANE_MSGID_2 || __MSGID_COMMENT)
meta T_INVALID_MSGID8		__HAS_MSGID && !(__SANE_MSGID_2 || __SPECIAL_MSGID)
meta T_INVALID_MSGID9		__HAS_MSGID && !(__SANE_MSGID_3 || __MSGID_COMMENT)
meta T_INVALID_MSGID10		__HAS_MSGID && !(__SANE_MSGID_3 || __SPECIAL_MSGID)
meta T_INVALID_MSGID11		__HAS_MSGID && !(__SANE_MSGID_4 || __MSGID_COMMENT)
meta T_INVALID_MSGID12		__HAS_MSGID && !(__SANE_MSGID_4 || __SPECIAL_MSGID)
meta T_INVALID_MSGID13		__HAS_MSGID && !(__SANE_MSGID_5 || __MSGID_COMMENT)
meta T_INVALID_MSGID14		__HAS_MSGID && !(__SANE_MSGID_5 || __SPECIAL_MSGID)

# these rules may need to factor in ok_languages or ok_locales
# Dec 18 2002 jm: but how? ;)  They are ready to be promoted otherwise
#freqs:  0.084   0.2047   0.0095    0.956   0.84    0.01  T_BODY_UNPRINTABLE
body T_BODY_UNPRINTABLE		/[\x00-\x07\x0b\x0c\x0e-\x1f\x7f]{3,}/
describe T_BODY_UNPRINTABLE	Body includes 3 consecutive unprintable characters

########################################################################
# bug 1106: forged MUAs
# only needed a \b around the shortest X-Mailer regular expressions

# Mozilla
# Dec 10 2002 jm: dan, you have fps for this, could you check 'em?
#
# 12/26 quinlan: my FPs are fixed now, all three versions of the rule
# have zero FPs for me now, only easmith benefits a very small amount
# from versions 2 and 3.
#
header __MOZILLA_MUA		X-Mailer =~ /\bMozilla\b/
header __MOZILLA_MSGID		MESSAGEID =~ /^<[A-F\d]{8}\.[A-F\d]{4,8}\@\S+>$/
meta T_FORGED_MUA_MOZILLA	(__MOZILLA_MUA && !__UNUSABLE_MSGID && !__MOZILLA_MSGID)
describe T_FORGED_MUA_MOZILLA	Forged mail pretending to be from Mozilla
score T_FORGED_MUA_MOZILLA	1.0

# Hmm... maybe possible to use a variant on the check_outlook_timestamp_token
# test for the time component of the MOZILLA rules. - Allen
# Dec 24 2002 jm: probably worth a try.
# 12/26 quinlan: see above
header __MOZILLA_MSGID2         MESSAGEID =~ /^<[A-F\d]{8}\.[A-F\d]{4,8}\@\S+>$/m
meta T_FORGED_MUA_MOZILLA2      (__MOZILLA_MUA && !__UNUSABLE_MSGID && !__MOZILLA_MSGID2)
describe T_FORGED_MUA_MOZILLA2  Forged mail pretending to be from Mozilla (2)
score T_FORGED_MUA_MOZILLA2     1.0

# 12/26 quinlan: see above
header __MOZILLA_MSGID3         MESSAGEID =~ /^<[A-F\d]{8}\.[A-F1-9][A-F\d]{0,7}\@\S+>$/m
meta T_FORGED_MUA_MOZILLA3      (__MOZILLA_MUA && !__UNUSABLE_MSGID && !__MOZILLA_MSGID3)
describe T_FORGED_MUA_MOZILLA3  Forged mail pretending to be from Mozilla (3)
score T_FORGED_MUA_MOZILLA3     1.0

########################################################################

# Nov 12 2002 jm: not keen on this.  many ISPs do not provide rDNS these
# days as policy. stupid policy, but there we are. and SpamAssassin policy
# is not to punish users with stupid ISPs...
#
# Dec 20 2002 jm: should make fantastic meta-fodder though. ;)
#
#freqs: 11.817  22.1680   5.3554    0.805   0.53    0.01  T_SENDER_NO_REVERSE
header   T_SENDER_NO_REVERSE    eval:check_for_sender_no_reverse()
describe T_SENDER_NO_REVERSE    No reverse lookup for sender's IP

########################################################################
# bug 1192

# 12/29 - tvd - where do I start?  Lots of FPs, but here are the different x-mailer types:
# - mails from ebworld.com,netflix,veritas,etc: (__HAS_MSMAIL_PRI, "X-mailer: AspMail 2.4 (SMTP422575)")
# - mails from bu.edu (__HAS_MSMAIL_PRI, "X-mailer: AspMail 4.0 4.03 (SMT40D82AF)")
# - random mail (__HAS_MSMAIL_PRI, "X-Mailer: Microsoft Internet Mail 4.70.1155")
# - mail to linux-lvm mailing list (__HAS_MIMEOLE, "X-Mailer: Internet Mail Service (5.5.2653.19)")
# - mails from EFF (__HAS_MSMAIL_PRI, "X-Mailer: JMail 4.1.2 by Dimac")
# - mails to mkrdns mailing list (__HAS_MSMAIL_PRI, "X-Mailer: Lotus Notes Release 5.0.6a  January 17, 2001")
# - random mails (__HAS_MSMAIL_PRI, "X-Mailer: SquirrelMail (version 1.2.6)")
# - mail to WGBH members (__HAS_MIMEOLE, "X-Mailer: UnityMail")
# - mail from jobfind.com (__HAS_MIMEOLE, "X-Mailer: SearchEase Engine. V2.7.27")
# - mail reporting abuse from hotmail (__HAS_MIMEOLE, "X-Mailer: Microsoft CSS 2000")
header __HAS_OUTLOOK_IN_MAILER2	X-Mailer =~ /Microsoft (CDO|Outlook)\b/
meta T_MISSING_OUTLOOK_NAME	((__HAS_MIMEOLE || __HAS_MSMAIL_PRI) && __HAS_X_MAILER && !__HAS_OUTLOOK_IN_MAILER2)

########################################################################

rawbody T_MIME_DEFICIENT_QP	eval:check_for_mime('mime_qp_illegal')
describe T_MIME_DEFICIENT_QP	Deficient quoted-printable encoding in body

