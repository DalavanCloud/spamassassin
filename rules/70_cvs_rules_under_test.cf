# SpamAssassin rules file: CVS rules under test
#
# This file is a placeholder for rules "under probation", ie. checked into
# CVS for testing. It should not be distributed; if the rules have good
# stats after a mass-check or two, then fold them into the distributed
# rules files.
#
# I suggest adding a prefix to rules in this file, "T_" -- this
# helps identify probationary rules in test output.
#
###########################################################################

# should be fixed now
# updated per bug 1217
# %%% INVALID_MSGID
# Dec 17 2002 jm: added subtest since part of my corpus has no msgid
# Dec 17 2002 jm: btw, one FP is for
# <41340.2001:770:18:1:250:4ff:feea:4364.1028136205.squirrel@webmail.heanet.ie>,
# ie an IPv6 address in the msgid.  Not sure if that's interesting or not ;)
header __VALID_MSGID MESSAGEID =~ /^<(?:[a-zA-Z0-9.,!\#\$%&'*\+\/=?\^_{}|~-]+|\".+\")\@(?:[a-zA-Z0-9_.-]+|\[\d{1,3}(?:\.\d{1,3}){3}\])>(?:\s*\(.*\))?\s*$/m [if-unset: <NO@MSGID>]
header __HAS_MSGID		MESSAGEID =~ /\S/
meta T_INVALID_MSGID		__HAS_MSGID && !__VALID_MSGID
describe T_INVALID_MSGID	Message-Id is not valid, according to RFC 2822
#
# quinlan: If this has a better S/O for others (all of my FPs are from the
# same person), it should be an eval so this can be done properly: strip
# comments on each Message-Id header, then use regular expression.
# Dec 18 2002 jm: S/Os aren't much better for others, but I think we should
# do it that way anyway.
#
header __MSGID_COMMENT		MESSAGEID =~ /\(.*\)/m
meta T_INVALID_MSGID2		__HAS_MSGID && !(__VALID_MSGID || __MSGID_COMMENT)


# these rules may need to factor in ok_languages or ok_locales
# Dec 18 2002 jm: but how? ;)  They are ready to be promoted otherwise
#freqs:  0.084   0.2047   0.0095    0.956   0.84    0.01  T_BODY_UNPRINTABLE
body T_BODY_UNPRINTABLE		/[\x00-\x07\x0b\x0c\x0e-\x1f\x7f]{3,}/
describe T_BODY_UNPRINTABLE	Body includes 3 consecutive unprintable characters
#freqs:  3.660   9.4529   0.0442    0.995   0.96    0.01  T_BODY_8BITS
body T_BODY_8BITS		/[\x80-\xff]{8,}/
describe T_BODY_8BITS		Body includes 8 consecutive 8-bit characters

########################################################################
# bug 1106: forged MUAs
# only needed a \b around the shortest X-Mailer regular expressions

# Mozilla
# Dec 10 2002 jm: dan, you have fps for this, could you check 'em?
header __MOZILLA_MUA		X-Mailer =~ /\bMozilla\b/
header __MOZILLA_MSGID		MESSAGEID =~ /^<[A-F\d]{8}\.[A-F\d]{4,8}\@\S+>$/
meta T_FORGED_MUA_MOZILLA	(__MOZILLA_MUA && !__UNUSABLE_MSGID && !__MOZILLA_MSGID)
describe T_FORGED_MUA_MOZILLA	Forged mail pretending to be from Mozilla
score T_FORGED_MUA_MOZILLA	1.0

# Hmm... maybe possible to use a variant on the check_outlook_timestamp_token
# test for the time component of the MOZILLA rules. - Allen

header __MOZILLA_MSGID2         MESSAGEID =~ /^<[A-F\d]{8}\.[A-F\d]{4,8}\@\S+>$/m
meta T_FORGED_MUA_MOZILLA2      (__MOZILLA_MUA && !__UNUSABLE_MSGID && !__MOZILLA_MSGID2)
describe T_FORGED_MUA_MOZILLA2  Forged mail pretending to be from Mozilla (2)
score T_FORGED_MUA_MOZILLA2     1.0

header __MOZILLA_MSGID3         MESSAGEID =~ /^<[A-F\d]{8}\.[A-F1-9][A-F\d]{0,7}\@\S+>$/m
meta T_FORGED_MUA_MOZILLA3      (__MOZILLA_MUA && !__UNUSABLE_MSGID && !__MOZILLA_MSGID3)
describe T_FORGED_MUA_MOZILLA3  Forged mail pretending to be from Mozilla (3)
score T_FORGED_MUA_MOZILLA3     1.0

# note: T_FORGED_MUA_MOZILLA4 now obsolete since I put the CWT/DCE thing into
# check_messageid_not_usable()

########################################################################

# this is the only To/Cc/From "no lower" version of this idea with a
# somewhat reasonable S/O ratio
# Dec 18 2002 jm: not bothered with this
header T_FROM_NO_LOWER		From !~ /[a-z]/

###########################################################################

body T_BANG_GUARANTEE		/\bguaranteed?\!/i

##################################################################

# Dec 18 2002 jm:
# pretty good, will promote it tomorrow once Allen's had a look at
# excluding his FPs
header __IDENT_NOBODY		Received =~ /ident[:=]nobody\b/i
header __REGSITE_COM		Received =~ /\.registeredsite\.com\s/
meta T_IDENT_NOBODY		(__IDENT_NOBODY && !__REGSITE_COM)
describe T_IDENT_NOBODY		Message was sent by nobody
score T_IDENT_NOBODY		1.0
# Allen's version
meta T_IDENT_NOBODY2		(__IDENT_NOBODY && !__REGSITE_COM && !((FORGOTTEN_PASSWORD + SUBJECT_IS_LIST + T_X_BEENTHERE + KNOWN_MAILING_LIST) > 1))


# jm: commented, this hits slist mail traffic, e.g.
# the <mozilla-general@mozilla.org> list.   Note that the moz lists have a
# very high spam load, which may explain why the resulting freqs look good
#header __T_MSGID_11	MESSAGEID =~ /^<?\d\w+\$\w{4,}\@/m
# tvd: these fp a bit, so they're disabled
#header __T_MSGID_37	MESSAGEID =~ /^<?\d{13,}\.SM\d+\@[^>]/m
#header __T_MSGID_16	MESSAGEID =~ /^<?[A-Z]\d{10}\@/m
# percents are fp percent of spam hits ...
# 52% fp for daf
#header T_BAD_MSGID_19	MESSAGEID =~ /^<?\w{7}-\w{6}-\w{2}\.\d{4}(?:-\d{2}){5}\@/m
# these are all message ids from exchange, the front part is a server name...
# 10% for rod
#header T_BAD_MSGID_20	MESSAGEID =~ /^<?EXCH\S+\@/m
# 10% for dan, 7% for rod, <1% for tvd
#header T_BAD_MSGID_24	MESSAGEID =~ /^<?[A-Z0-9_-]*SERV[A-Za-z0-9_-]+[0-9a-f]{8}\@/m
# 40% for rod
#header T_BAD_MSGID_26	MESSAGEID =~ /^<?[A-Z0-9_-]*MAIL[a-zA-Z0-9_-]+0000[0-9a-f]{4}\@/m
#meta T_MSGID_S_1	( T_BAD_MSGID_.+ + ) > 0
# only tvd
#header T_BAD_MSGID_17	MESSAGEID =~ /^<?DGTBAD\S+\@/m

# 10% justin, 16% for rod
# jm: definite FPs: redhat-list ML, Palmgear.com monthly download stats
header T_SPAM_MSGID_32	MESSAGEID =~ /^<?auto-00000\d+\@/m

# Matt Cline: New ratware and user-agent tests
header T_RATWARE_BIXON       X-Mailer =~ /Bixon ThunderMail/
header T_RATWARE_BULK_MAILER X-Mailer =~ /BulkMailer/


# Dec 20 2002 jm: let's try and catch these spammers out
header __XIMIAN_MUA	     X-Mailer =~ /^(?:Ximian Evolution|Evolution\/\d+\.)/
# interestingly the last word (\S+) always seems to be 'camel' ;)
header __XIMIAN_MSGID	     MESSAGEID =~ /^<\d{10}\.\d+\.\d+\.\S+\@/
meta T_USER_AGENT_XIMIAN     (__XIMIAN_MSGID && __XIMIAN_MUA && !__UNUSABLE_MSGID)
score  T_USER_AGENT_XIMIAN   -0.5
tflags T_USER_AGENT_XIMIAN   nice

##############################################################################

# Nov 12 2002 jm: not keen on this.  many ISPs do not provide rDNS these
# days as policy. stupid policy, but there we are. and SpamAssassin policy
# is not to punish users with stupid ISPs...
#
# Dec 20 2002 jm: should make fantastic meta-fodder though. ;)
#
#freqs: 11.817  22.1680   5.3554    0.805   0.53    0.01  T_SENDER_NO_REVERSE
header   T_SENDER_NO_REVERSE    eval:check_for_sender_no_reverse()
describe T_SENDER_NO_REVERSE    No reverse lookup for sender's IP

# Matt Cline, Bug #1220 (all already in)

# bug 1207:
#
# these do not work so well (daf+easmith+quinlan+rODbegbie+theo)
# jm: agreed. :(
#freqs:  0.039   0.0632   0.0237    0.728   0.37    0.01  T_DOUBLE_SQUOTES_1
#freqs:  0.055   0.0682   0.0473    0.590   0.20    0.01  T_DOUBLE_SQUOTES_2
#freqs:  0.046   0.0632   0.0347    0.645   0.26    0.01  T_DOUBLE_SQUOTES_3
#
header T_DOUBLE_SQUOTES_1 Subject =~ /''\w+''/
describe T_DOUBLE_SQUOTES_1 Evading word tests with two single quotes
test T_DOUBLE_SQUOTES_1 ok  ''this'' is ''spam''
test T_DOUBLE_SQUOTES_1 fail 'this is quoted'

header T_DOUBLE_SQUOTES_2 Subject =~ /''/
describe T_DOUBLE_SQUOTES_2 Evading word tests with two single quotes
test T_DOUBLE_SQUOTES_2	ok ''
test T_DOUBLE_SQUOTES_2 fail 'hi'

header T_DOUBLE_SQUOTES_3 Subject =~ /''.{0,15}''/
describe T_DOUBLE_SQUOTES_3 Evading word tests with two single quotes
test T_DOUBLE_SQUOTES_3 ok ''buy now''
test T_DOUBLE_SQUOTES_3 fail 'asdfasdfasdf'

# Here are some tests for weird double quoting in the body (I tried 37
# variations, these are the best 10, in rough order best RANK to worst
# RANK). - quinlan
# P.S. I feel really icky after writing these.
body T_BODY_QUOTES_01	/(["'])\1\S{0,15}(["'])\1/
body T_BODY_QUOTES_02	/(["']{2})\S{0,15}\1/
body T_BODY_QUOTES_03	/(["'\222\223\224\262\263\271])\1\S{0,15}(["'\222\223\224\262\263\271])\1/
body T_BODY_QUOTES_04	/(["'\222\223\224\262\263\271]{2})\S{0,15}\1/
body T_BODY_QUOTES_05	/['\222\223\224\262\263\271]{2}\S{0,15}['\222\223\224\262\263\271]{2}/
body T_BODY_QUOTES_06	/["'\222\223\224\262\263\271]{2}.{0,15}["\222\223\224\262\263\271]{2}/
body T_BODY_QUOTES_07	/(["'\222\223\224\262\263\271]{2}).{0,15}\1/
body T_BODY_QUOTES_08	/(["'])\1.{0,15}(["'])\1/
body T_BODY_QUOTES_09	/(["']{2}).{0,15}\1/
body T_BODY_QUOTES_10	/(["'\222\223\224\262\263\271])\1.{0,15}(["'\222\223\224\262\263\271])\1/

#bug 1010
body T_CHECK_EMAIL_ISFREE	eval:check_email_isfree()
describe T_CHECK_EMAIL_ISFREE Body contains an e-mail address listed by Email::IsFree

# numeric mailto
# Dec 20 2002 jm: my FPs *do not* contain this pattern! does.. not.. compute...
# ok, it's the implicit addition of "mailto:" for mail-addr lookalikes, which
# also includes user@host CVSroot specs etc.  Let's try using a rawbody pattern.
rawbody T_NUMERIC_MAILTO_ADDR	/\bmailto:[^\s\@]{1,20}\@\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b/is

#bug 652
header T_SUBJ_BUY			Subject =~ /^buy/i
describe T_SUBJ_BUY		Subject starts with Buy, Buying

# bug 1014
# from Allen

header __FROM_HAS_UNDERLINE_NUMS	From =~ /_\S?(?:[a-z]+\w*?\d+|\d+\w*?[a-z]+)\w*\@/i
meta T_FROM_HAS_UNDERLINE_NUMS		(!T_REPLY_TO_HAS_UNDERLINE_NUMS && __FROM_HAS_UNDERLINE_NUMS)
describe T_FROM_HAS_UNDERLINE_NUMS	From: contains an underline and numbers/letters

# from bug 1173
# drop it; lots of spam comes via MM lists, esp. since I've seen spammers using
# MM-specific web crawlers, so this is not a good rule
#header T_X_BEENTHERE		exists:X-BeenThere
#describe T_X_BEENTHERE	X-BeenThere header exists

# HTML charset tests
body __HTML_CHARSET_FARAWAY	eval:html_charset_faraway()
meta T_HTML_CHARSET_FARAWAY	(__HTML_CHARSET_FARAWAY && __HIGHBITS)

# bug 1300: rule speed-ups, these are purely for speeding up SLOW rules,
# although the hit rates are expected to change a tiny bit.  (You do not
# want to think about how slow testing these will be!)
body T_MORTGAGE_BEST		/\b(?:low(?:est|er)?|free|second|rate|best|refinanc(?:e|ing)|online|instant) mortgage/i
body T_CELEBRITY_PORN             /\bceleb(?:rity|rities|s).{0,15}(?:sex|porn|pics|caught|nude|exposed|content)|(?:steamy|hot|nude|shocking|free|h[a\@]rdcore) celeb(?:rity|rities|s)\b/i
body T_CELL_PHONE_BOOST_1	/\b(?:(?:boost|antenna|reception).{0,32}(?:cell|mobile|phone|cord.?less)|(?:cell|mobile|phone|cord.?less).{0,32}(?:boost|antenna|reception))/i
body T_CELL_PHONE_BOOST_2	/\b(?:(?:boost|antenna|reception).{0,24}(?:cell|mobile|phone|cord.?less)|(?:cell|mobile|phone|cord.?less).{0,24}(?:boost|antenna|reception))/i
body T_CELL_PHONE_BOOST_3	/\b(?:(?:boost|antenna|reception).{0,16}(?:cell|mobile|phone|cord.?less)|(?:cell|mobile|phone|cord.?less).{0,16}(?:boost|antenna|reception))/i
body T_OFFERS_ETC_1		/(?:\b(?:wish|want|unsub|reward|receive|recurring|remove|permission|partner|further|future|e.?mail|continue|click).{0,64}){2}.{0,8}(?:special|offer|coupon|discount)s?\b/i
body T_OFFERS_ETC_2		/\b(?:(?:wish|want|unsub|reward|receive|recurring|remove|permission|partner|further|future|e.?mail|continue|click).{0,64}){2}.{0,8}(?:special|offer|coupon|discount)s?\b/i
body T_OFFERS_ETC_3		/(?:\b(?:wish|want|unsub|reward|receive|recurring|remove|permission|partner|further|future|e.?mail|continue|click).{0,48}){2}.{0,8}(?:special|offer|coupon|discount)s?\b/i
body T_OFFERS_ETC_4		/\b(?:(?:wish|want|unsub|reward|receive|recurring|remove|permission|partner|further|future|e.?mail|continue|click).{0,48}){2}.{0,8}(?:special|offer|coupon|discount)s?\b/i
body T_OFFERS_ETC_5		/(?:\b(?:wish|want|unsub|reward|receive|recurring|remove|permission|partner|further|future|e.?mail|continue|click).{0,32}){2}.{0,8}(?:special|offer|coupon|discount)s?\b/i
body T_OFFERS_ETC_6		/\b(?:(?:wish|want|unsub|reward|receive|recurring|remove|permission|partner|further|future|e.?mail|continue|click).{0,32}){2}.{0,8}(?:special|offer|coupon|discount)s?\b/i

# 708
body T_OFFER_1			/\b(?:free|trial|full|phone|points?|hottest|internet|great|of this|about this|dealer|responded|not an|pay|are able to|future|valuable|partner|receiv(?:e|ed|ing)|introductory|exclusive|promotional|coupon|bonus|further|following|product|proud to|additional|website|amazing|discounts?)\b.{0,9}(?:this|these|)\boffer(?:s|ings?|ed|)\b/i
describe OFFER			Offers you Something

body T_OFFER_2			/\boffer(?:s|ings?|)\b.{0,9}\b(?:expires|subject|limited|ends|mailed|originator|contained|discounts?|confidential|is ood|available|valid|in error|!)\b/i
describe T_OFFER_2		Offers you Something (2)

body T_OFFER_3			/this offer is|we offer (?:you|over)|offers?@/i
describe T_OFFER_3		Offers you Something (3)

body T_SPECIAL_OFFER		/\bspecial .{0,15}\boffer(?:s|ings?|ed|)/i
describe T_SPECIAL_OFFER		Special Offer

uri T_OFFER_URI			/^https?:\/\/.*?(?:offers?\.\w|[.\/]offer|offer=)/i 
describe T_OFFER_URI		Offer in link address

# bug 726
body T_VISIT_OUR_SITE /\b(?:visit|enter)\s+(?:my|our|the|this)\s+(?:web\s*)?site/i
describe T_VISIT_OUR_SITE         Wants you to visit a web site
test T_VISIT_OUR_SITE  ok  Click below to enter our web site:
test T_VISIT_OUR_SITE  ok  Visit Our Web Site and Learn The Facts
test T_VISIT_OUR_SITE  ok  Just visit our site to learn how easy
test T_VISIT_OUR_SITE  ok  Visit the sites of our major partners:
# Dec 19 2002 jm: try out separation of "the", it seems to be FP-prone for me
body T_VISIT_OUR_SITE_2 /\b(?:visit|enter)\s+(?:my|our|this)\s+(?:web\s*)?site/i

# bug 878
# seems to inserted with s1618 rules VERY heavily
body WE_HATE_SPAM2 /anti-spam policy/i
describe WE_HATE_SPAM2 Spammer is against spam -- aren't we all?

uri T_PXE_LOGIC /^http:\/\/(?:pxe|fx)\.[^\/]{1,50}\.com\/logic\/to\.pl\?/i
test T_PXE_LOGIC ok http://pxe.highspeed-email.com/logic/to.pl?i=3399923cd33d
describe T_PXE_LOGIC Spam URL pattern, usually made up domains

# mgm's rules for PXE above
uri T_DAILY_PL			/\/logic\/[a-z]{2}\.pl/
describe T_DAILY_PL		Spam URL pattern, DailyPromotions redirect link

uri T_DAILY_PXE			/http:\/\/(?:pxe|fx)\./i
describe T_DAILY_PXE		Spam URL pattern, DailyPromotions server link

# Specific whitelisting for GradFinder.  They use the sender's own
# From addr, so whitelist_from_rcvd won't cut it
# bug 1241
header __GRADF_MSGID	Message-ID =~ /\@gradfinder.com>$/
header __GRADF_RCVD	Received =~ /from \S+ \(\S+.friendfinder.com \[216\.34\./
meta T_VIA_GRADFINDER	(__GRADF_RCVD && __GRADF_MSGID)
tflags T_VIA_GRADFINDER	nice

# bug 1171
# Listproc - Allen (example: nonspam:<199811090515.AAA28259@chem.harvard.edu>)
header T_LISTPROC1		X-Listprocessor-version =~ /^\s*(?:\d\.)+\w*\s+--\s+List[Pp]roc(?:essor)?\b/
score T_LISTPROC1		-0.01
tflags T_LISTPROC1		nice

header __FROM_LISTPROC		From =~ /\blistproc\@/i
header __REPLY_LISTPROC		Reply-To =~ /\blistproc\@/i
header __SENDER_LISTPROC	Sender =~ /\blistproc\@/i
meta T_LISTPROC2		T_LISTPROC1 && __FROM_LISTPROC && (__REPLY_LISTPROC || __SENDER_LISTPROC)
score T_LISTPROC2		-0.01
tflags T_LISTPROC2		nice

# bug 1010
uri T_SUPER_BARGAINS_URL	/\bsuper-bargains\.com/
uri T_FANTASTIC_BARGAIN_URL	/\bfantastic-bargain\.com/
uri T_KAVKAZCENTER_URL		/\bkavkazcenter\.com/
uri T_FINESTOFFERS_URL		/\bfinestoffers\.com/
uri T_AEOPUBLISHING_URL		/\baeopublishing\.com/
uri T_SKY08_URL			/\bsky08\.com/
uri T_E_MAILPROMO_URL		/\be-mailpromo\.net/
uri T_MARINEDIGITAL_URL		/\bmarinedigital\.com/
uri T_ITSREMARKABLE_URL		/\bitsremarkable\.com/
#
uri T_SUPER_BARGAINS_MAILTO	/mailto:\S+[.@]super-bargains\.com/
uri T_FANTASTIC_BARGAIN_MAILTO	/mailto:\S+[.@]fantastic-bargain\.com/
uri T_KAVKAZCENTER_MAILTO	/mailto:\S+[.@]kavkazcenter\.com/
uri T_FINESTOFFERS_MAILTO	/mailto:\S+[.@]finestoffers\.com/
uri T_AEOPUBLISHING_MAILTO	/mailto:\S+[.@]aeopublishing\.com/
uri T_SKY08_MAILTO		/mailto:\S+[.@]sky08\.com/
uri T_E_MAILPROMO_MAILTO	/mailto:\S+[.@]e-mailpromo\.net/
uri T_MARINEDIGITAL_MAILTO	/mailto:\S+[.@]marinedigital\.com/
uri T_ITSREMARKABLE_MAILTO	/mailto:\S+[.@]itsremarkable\.com/

header T_WITH_LC_SMTP		Received =~ /\swith\ssmtp;\s/
describe T_WITH_LC_SMTP		Received line contains spam-sign (lowercase smtp)

# bug 1211
body     __BILL_1618    /\D301\D+a\W*2\W*c\D+1618\D/i
describe __BILL_1618    Possible mention of bill 1618 (anti-spam bill)
meta     T_ANTISPAM_BILL  REMOVE_IN_QUOTES && __BILL_1618
describe T_ANTISPAM_BILL  Very likely mention of anti-spam bill

