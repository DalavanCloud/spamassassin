#!/bin/sh

# 50 * * * * /home/jm/ftp/spamassassin/build/gen_freqs_from_nightly_mc

outdir=/home/jm/spamassassin.taint.org/qa/freqs

cd /home/jm/ftp/spamassassin/masses

(
echo "STARTING AT"; date

# you need to create this file with RSYNC_USERNAME and RSYNC_PASSWORD
# settings for your account in it.

. nightly_mc_passwords
export RSYNC_PASSWORD

mkdir all-results >/dev/null 2>&1
rsync -vrz $RSYNC_USERNAME@belphegore.hughes-family.org::corpus/. all-results

# now grep out the ones built today, and put copies into "usable-results"
today=`date +"%b %e"`   # "Oct 17"
rm -rf usable-results
mkdir usable-results >/dev/null 2>&1
for f in all-results/*.log ; do
  if grep "mass-check results from" $f | grep "$today" > /dev/null ; then
    cp $f usable-results
  fi
done

cat usable-results/nonspam-*.log > nonspam.log
cat usable-results/spam-*.log > spam.log
make clean ; make freqs

nowdir=$outdir/`date +%Y%m%d`
mkdir -p $nowdir > /dev/null 2>&1

cp freqs $nowdir
date > $nowdir/LAST_UPDATE

echo $nowdir
ls -l $nowdir

echo "FINISHED AT"; date

) > nightly.log 2>&1

