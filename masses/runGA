#!/bin/sh

# set SCORESET
. config

LEARN_RATE="${LEARN_RATE:-2.0}"

NAME="set$SCORESET"
LOGDIR="gen-$NAME-$HAM_PREFERENCE-$THRESHOLD-$EPOCHS-ga"

# ensure sandbox T_ rules aren't used in the GA and don't appear in output
KILL_SANDBOX_RULES=y

###########################################################################

[ -d gen-cache ] || mkdir gen-cache     # a cache, woo

if [ "$NOTE" != "" ]; then
	LOGDIR="$LOGDIR-$NOTE"
fi

if [ ! -f "ORIG/ham-$NAME.log" -o ! -f "ORIG/spam-$NAME.log" ]; then
	echo "Couldn't find logs for $NAME" >&2
	exit 1
fi

if [ "x$1" = "x" ]; then

(	# log this

set -x	# trace commands to the log

# Create a directory to organize the logs with this group of settings
mkdir -p $LOGDIR $LOGDIR/NSBASE $LOGDIR/SPBASE

if ! [ -d $LOGDIR ] ; then
  echo "Failed to mkdir $LOGDIR, dying" 1>&2
  exit 1
fi

# This should be in here instead.  Prevents testing.
# svn revert ../rules/50_scores.cf

rm -rf tmprules
cp -r ../rules tmprules

cp tmprules/50_scores.cf orig_scores.cf

# fix all scores to non-zero (avoid a possible bug, not quite sure)
./enable-all-evolved-rules < tmprules/50_scores.cf \
	> tmprules/50_scores.cf.new || exit 1
mv tmprules/50_scores.cf.new tmprules/50_scores.cf

[ $KILL_SANDBOX_RULES = y ] && rm tmprules/70_sandbox.cf

echo "[Doing a scoreset $SCORESET score-generation run]"

# Clean out old runs
echo "[Cleaning up]"
rm -rf spam-test.log ham-test.log spam.log ham.log \
	NSBASE SPBASE tmp make.output freqs perceptron.scores \
	garescorer.scores
make clean

# Generate 90/10 split logs
# keep the *-split*.logs in cwd so it's cacheable
echo "[Generating 90/10 split ham]"
perl tenpass/split-log-into-buckets-cached \
    9:gen-cache/ham-split9.log 1:gen-cache/ham-split1.log ORIG/ham-$NAME.log
ln gen-cache/ham-split9.log $LOGDIR/NSBASE/ham.log
ln gen-cache/ham-split1.log $LOGDIR/NSBASE/ham-test.log

echo "[Generating 90/10 split spam]"
perl tenpass/split-log-into-buckets-cached \
    9:gen-cache/spam-split9.log 1:gen-cache/spam-split1.log ORIG/spam-$NAME.log
ln gen-cache/spam-split9.log $LOGDIR/SPBASE/spam.log
ln gen-cache/spam-split1.log $LOGDIR/SPBASE/spam-test.log

echo "[Setting up for gen run]"
# Ok, setup for a run
ln -s $LOGDIR/SPBASE/spam.log .
ln -s $LOGDIR/NSBASE/ham.log .
ln -s $LOGDIR/SPBASE/spam-test.log .
ln -s $LOGDIR/NSBASE/ham-test.log .

# try to find number of processors
numcpus=`cpucount 2>/dev/null || egrep -c '^processor\b' /proc/cpuinfo 2>/dev/null || echo 1`

echo "[Generating GA]"
# Generate GA with full logs
make -j $numcpus SCORESET=$SCORESET garescorer > $LOGDIR/make.output 2>&1
cp freqs $LOGDIR/freqs

echo "[config]"
cat config
echo "[gen run start]"
pwd
date

# misuse EPOCHS as pop size
./garescorer -b $HAM_PREFERENCE -s $EPOCHS -t $THRESHOLD

# POST-GA COMMANDS:

mv garescorer.scores $LOGDIR/scores
echo "[gen run end]"

cp orig_scores.cf tmprules/50_scores.cf
perl ./rewrite-cf-with-new-scores $SCORESET tmprules/50_scores.cf \
	$LOGDIR/scores > tmprules/50_newscores.cf
mv tmprules/50_newscores.cf tmprules/50_scores.cf
cp tmprules/50_scores.cf $LOGDIR/50_scores.cf

perl ./fp-fn-statistics --ham ham-test.log --spam spam-test.log \
    --scoreset $SCORESET --cffile=tmprules \
    --fnlog $LOGDIR/false_negatives --fplog $LOGDIR/false_positives \
    > $LOGDIR/test

# END OF POST-GA COMMANDS

) | tee $LOGDIR/log

else

# Statistics generation, once everyone likes the scores

  [ $KILL_SANDBOX_RULES = y ] && rm ../rules/70_sandbox.cf

  # This needs to have ../rules/50_scores.cf in place first ...
  echo "[gen test results for set $SCORESET]"
  perl ./fp-fn-statistics --ham ham-test.log --spam spam-test.log \
      --scoreset $SCORESET --cffile=../rules | tee $LOGDIR/test

  echo "[STATISTICS file generation for set $SCORESET]"
  bash ./mk-baseline-results $SCORESET | tee $LOGDIR/statistics

  cp $LOGDIR/statistics ../rules/STATISTICS-set${SCORESET}.txt
  ls -l ../rules/STATISTICS-set${SCORESET}.txt

fi

exit 0
