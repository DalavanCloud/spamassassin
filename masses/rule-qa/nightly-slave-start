#!/bin/sh

echo "Using ssh-nightly-slave settings from $HOME/.corpus"
. $HOME/.corpus

host="$1"

# use $PERL from env if unset
[ "x${PERL:-}" = x ] && PERL=perl
set -x
set -e

tar=tar
[ -x /usr/sfw/bin/gtar ] && tar=/usr/sfw/bin/gtar

cd $tree
$tar cfz $tmp/tf \
        --exclude="*.log" \
        --exclude=".svn" \
        --exclude="tmp" \
        .

[ "$clienttree" = "" ] && clienttree=tree

ssh $host \
    rm -rf $clienttree \; \
    mkdir $clienttree \; \
    cd $clienttree \; \
    tar xfz - < $tmp/tf 

# source /etc/profile to get a full $PATH, including /usr/local/bin
# (some hosts need to use /usr/local/bin/perl instead of /usr/bin/perl).
# rebuild to compile the blib modules for this platform.

ssh $host \
    cd $clienttree \; \
    . /etc/profile \; \
    perl Makefile.PL \; \
    make clean \; \
    perl Makefile.PL \; \
    make < /dev/null > $tmp/remote_build.$host.log

ssh -f $host \
    cd $clienttree/masses \; \
    . /etc/profile \; \
    TZ=UTC perl mass-check \
        --cs_ssl --cs_verbose --cs_cache --cs_cachedir=./cs_cache \
        --client $serverhost &

