#!/bin/sh

. $HOME/.corpus

# $HOME/.corpus should contain settings for these values:
#
# tree=/home/corpus/cvs/spamassassin
# username=joe
# password=xyzzy

renice 10 -p $$

set -x
set -e
export TIME="%e,%U,%S"
export TZ=UTC

# ensure we're running after 0900 UTC
if date | egrep -q '^... ... .. (08|10):'; then
	exit
fi

# day of week
if date | egrep -q '^Sat'; then
	net="net-"
else
	net=""
fi


cd $tree/masses

if [ "$1" = "update" ]; then
	# random sleep
	perl -e 'sleep int(rand(300));'
	# update
	cd ..
	set +e
	for retry in 0 1 2 4 8 16 32 64; do
		if cvs -z3 update -dP -r CURRENT_CORPORA_SUBMIT_VERSION; then
			break;
		fi
		if [ $retry -eq 64 ]; then
			exit 1
		fi
		sleep $(( 60 * $retry ))
	done
	set -e
	cd masses

	# run test
	rm -f spamassassin/bayes*
	date > test.start
	if date | egrep -q '^Sat'; then
		./mass-check --net -j 6 -f /home/corpus/mail/corpus
	else
		./mass-check -f /home/corpus/mail/corpus
	fi
	uptime
	date > test.end
fi

# submit results
export RSYNC_PASSWORD=$password
rsync -CPcvuzb --timeout=60 ham.log $username@belphegore.hughes-family.org::corpus/ham-$net$username.log
rsync -CPcvuzb --timeout=60 spam.log $username@belphegore.hughes-family.org::corpus/spam-$net$username.log
