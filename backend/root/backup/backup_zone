#!/bin/sh
#
# a basic backup script for the stuff on the zone; we can't check it all
# in due to (a) volume and (b) embedded rsync passwords in .corpus files etc.
#
# run as root, a la
#
#    sudo /export/home/svn-trunk/backend/root/backup/backup_zone

bupdir=/zonestorage/spamassassin/backup
[ `uname -n` = spamassassin2 ] && bupdir=/zonestorage/spamassassin2/backup

###########################################################################

die () {
  echo "$*" 1>&2
  exit 1
}

tarup () {
  dir="$1"
  name=$2

  tar=tar; [ -x /usr/sfw/bin/gtar ] && tar=/usr/sfw/bin/gtar
  excludedir=`dirname $0`

  touch $name.tgz $name.log
  chmod 600 $name.tgz $name.log

  (
    nice -20 $tar --create --file=-  \
        --sparse --exclude-from=$excludedir/excludes   \
        --label="Backup of $dir at `date`"  \
        "$dir" | nice -20 gzip -2

  ) > $name.tgz 2>$name.log
}

###########################################################################

mkdir -p $bupdir 2>/dev/null
cd $bupdir || die "failed to cd to $bupdir"

for dir in `ls /export/home` ; do

  [ "$dir" = "OBSOLETE" ] && continue
  tarup /export/home/$dir        export-home-$dir

done

tarup /usr/local                 usr-local
tarup /opt                       opt
tarup /local                     local
tarup /etc                       etc

ls -l $bupdir/*.tgz
exit 0
