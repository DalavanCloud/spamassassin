#!/bin/sh

user="$1"
[ "$user" = "" ] && echo "usage: run_one_nitemc username"
[ "$user" = "" ] && exit 99

# where the $HOMEs are:
userdir=/export/home/nitemc/$user
svndir=/export/home/nitemc/svn

mkdir -p $userdir
log=$userdir/log
mv $log $log.1

(
echo "Starting corpus-nightly for $user ($svndir , $userdir)"

. /etc/profile
HOME=$userdir
PERL=/local/perl586/bin/perl
TMPDIR=/tmpfs

export HOME PERL TMPDIR

# create the .corpus file, keeping the rsync password secret;
# the string __RSYNC_PASSWORD__ will be replaced with the
# contents of /export/home/nitemc/USERNAME/rsync_password

src=$svndir/backend/nitemc/corpus.$user
[ -f $src ] || src=$svndir/backend/nitemc/corpus.default

perl -pe '
  s{__RSYNC_PASSWORD__}{ incfile("rsync_password") }eg;
  s{__CLIENTHOSTS__}{ incfile("svn/backend/nitemc/clienthosts") }eg;

  sub incfile {
    my $file = shift;
    my $new=`cat '"$userdir"'/$file`; chop $new; $new =~ s/\s+/ /gs;
    return "\"".$new."\"";
  }
' $src > $userdir/.corpus

rm -rf $svndir/masses/tmp
rm -rf $svndir/masses/spamassassin
rm -rf $svndir/masses/*.log

# use bash to work around Solaris breakage
exec nice bash $svndir/masses/rule-qa/corpus-nightly

) 2>&1 | tee $log

