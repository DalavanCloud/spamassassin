#!/bin/sh -xe

. /export/home/jm/tools/setenvs

# clean everything first
rm -rf t/log t/log.* artifacts testxml || true
make distclean < /dev/null || true
mkdir artifacts testxml

perl Makefile.PL < /dev/null
make
make distcheck

# generate 't/log.make_test'
make test TEST_VERBOSE=1 \
    2>&1 | tee artifacts/make_test.log
mv t/log artifacts/t.log.make_test

# generate 't/log.make_disttest'
make disttest TEST_VERBOSE=1 < /dev/null \
    2>&1 | tee artifacts/make_disttest.log
mv Mail-SpamAssassin*/t/log artifacts/t.log.make_disttest

# and 't/log.make_test_p561'
make distclean < /dev/null || true
/home/jm/tools/perl561/bin/perl Makefile.PL < /dev/null
make
make test TEST_VERBOSE=1 \
    2>&1 | tee artifacts/make_test_p561.log
mv t/log artifacts/t.log.make_test_p561

# generate XML test reports
perl ./build/hudson/tap-to-junit-xml \
    < artifacts/make_test.log > testxml/make_test.xml
perl ./build/hudson/tap-to-junit-xml \
    < artifacts/make_disttest.log > testxml/make_disttest.xml
perl ./build/hudson/tap-to-junit-xml \
    < artifacts/make_test_p561.log > testxml/make_test_p561.xml

