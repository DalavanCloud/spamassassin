#!/usr/bin/perl -w
# 
# build/mkrules -- compile the SpamAssassin rules into installable form
#
# <@LICENSE>
# Copyright 2004 Apache Software Foundation
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# </@LICENSE>

# This is an implementation of
# http://wiki.apache.org/spamassassin/RulesProjPromotion 

sub usage {
  die "mkrules/run [--src srcdir] [--out outputdir]\n";
}

use File::Find;
use File::Copy;

use Getopt::Long;
use vars qw($opt_src $opt_out);
GetOptions("src=s", "out=s");

die "no src" unless ($opt_src);
die "no out" unless ($opt_out);
die "unreadable src" unless (-d $opt_src);
die "unreadable out" unless (-d $opt_out);

File::Find::find ({
          wanted => \&wanted,
          no_chdir => 1
        }, $opt_src);

sub wanted {
  return unless (-f $File::Find::name && /\d.*\.cf$/i);

  my $dir = $File::Find::name;
  $dir =~ s/^${opt_src}[\/\\\:]//s;
  $dir =~ s/([^\/\\\:]+)$//;
  my $file = $1;

  if ($dir =~ /sandbox/) {
    apply_sandbox_rules($dir, $file);
  }
  else {
    copy_rule_file_if_newer($dir, $file);
  }
}


sub copy_rule_file_if_newer {
  my ($dir, $file) = @_;

  my $f = "$opt_src/$dir/$file";
  my $t = "$opt_out/$file";

  if (!-r $t || -M $t > -M $f) {
    print "cp $f $t\n";
    copy($f, $t) or die "copy failed from $f to $t: $!\n";
  }
}

sub apply_sandbox_rules {
  my ($dir, $file) = @_;

  # TODO! this section should implement the validation criteria from
  # http://wiki.apache.org/spamassassin/RulesProjPromotion .
  #
  # right now, it just copies the file, raw.

  my $f = "$opt_src/$dir/$file";
  my $t = "$opt_out/$file";
  print "grepcp?? $f $t\n";
  copy($f, $t) or die "copy failed from $f to $t: $!\n";
}

