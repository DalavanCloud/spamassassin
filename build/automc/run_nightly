#!/bin/sh
#
# driver for nightly mass-checks on the zone. run from cron as:
# 10 9,10 * * * /home/automc/svn/spamassassin/build/automc/run_nightly > /var/www/buildbot.spamassassin.org/bbmass/nightly_masschecks.txt 2>&1

# add usernames who you want to do nightlies for here:
nightly_users="
  doc
  zmi
"

# and where the $HOMEs are:
nightly_trees="/home/bbmass/mc-nightly"

# create the targets files:
/home/automc/svn/spamassassin/build/automc/populate_cor_nightly

echo "run_nightly starting at" ; date

# and run each mass-check using "corpus-nightly"
for user in $nightly_users ; do
  dir="$nightly_trees/$user"

  echo "Starting corpus-nightly for $user ($dir)"

  (
    HOME=$dir

    # oh Solaris, you really suck
    PERL=/local/perl586/bin/perl
    PATH=$PATH:/usr/sfw/bin:/opt/sfw/bin:/opt/SUNWspro/bin:/usr/X/bin:/usr/ucb:/usr/sbin:/usr/ccs/bin:/opt/subversion-1.1.4/bin:/usr/apache2/bin:/local/bin

    export HOME PERL PATH

    # use bash to work around Solaris breakage
    bash $dir/svn/masses/rule-qa/corpus-nightly
  )

done

# cycle the logfiles; keep 6 (3 days worth I think)
(
  cd /var/www/buildbot.spamassassin.org/bbmass
  rm nightly_masschecks_6.txt
  mv nightly_masschecks_5.txt  nightly_masschecks_6.txt
  mv nightly_masschecks_4.txt  nightly_masschecks_5.txt
  mv nightly_masschecks_3.txt  nightly_masschecks_4.txt
  mv nightly_masschecks_2.txt  nightly_masschecks_3.txt
  mv nightly_masschecks_1.txt  nightly_masschecks_2.txt
  mv nightly_masschecks.txt    nightly_masschecks_1.txt
)

