#!/usr/bin/perl

use strict;
use warnings;

use Getopt::Long;

use vars qw(
    $pidfile
    $opt_wake
);
GetOptions(
    "pidfile=s" => \$pidfile,
    "wake" => \$opt_wake,
);

if ($opt_wake) {
  die "wake needs pidfile" if (!$pidfile);
  open(IN, "<$pidfile") or die "cannot read $pidfile";
  my $pid = <IN> + 0;
  close IN;

  if ($pid <= 1) {
    die "pid out of range: $pid";
  }

  kill (1,$pid) or die "kill -1 $pid failed";
  print "signalled $pid\n";
  exit;
}

# ---------------------------------------------------------------------------

# by separating this into two processes, we can get the parent reports issued
# immediately, and the slow reports can gronk away in the background

# the parent process continually generates the faster reports
my $parent_reports = "LOGS.all DETAILS.new DETAILS.all DETAILS.age ".
  "HTML.new HTML.all HTML.age NET.new NET.all NET.age SCOREMAP.new";

# the child process generates the slow reports
my $child_reports = "OVERLAP.new";

# seconds between build-polls
my $idle_sleep = 30;

# ---------------------------------------------------------------------------

my $am_parent;
my $child_pid = fork();
if ($child_pid < 0) {
  die "fork failed";
}
elsif ($child_pid != 0) {
  $am_parent = 0;
}
else {
  $am_parent = 1;
}

$SIG{HUP} = \&sighup_handler;
$SIG{INT} = \&sigterm_handler;
$SIG{TERM} = \&sigterm_handler;

if ($pidfile) {
  open(OUT, ">$pidfile") or die "cannot write to $pidfile";
  print OUT $$;
  close OUT or die "cannot save $pidfile";
}

while (1) {
  if ($am_parent) {
    parent_loop();
  }
  else {
    child_loop();
  }
}

# ---------------------------------------------------------------------------

sub parent_loop {
  print "starting faster reports ($$) at ".(scalar localtime time)."\n";
  system ("cd masses/rule-qa; ./corpus-hourly ".
        "--override='output_classes=$parent_reports'");
  print "completed faster reports ($$) at ".(scalar localtime time)."\n";

  sleep $idle_sleep;        # sleep until timeout, or we get SIGHUPped
}

# ---------------------------------------------------------------------------

sub child_loop {
  print "starting slow reports ($$) at ".(scalar localtime time)."\n";
  system ("cd masses/rule-qa; ./corpus-hourly ".
        "--override='output_classes=$child_reports'");
  print "completed slow reports ($$) at ".(scalar localtime time)."\n";

  sleep $idle_sleep;        # sleep until timeout, or we get SIGHUPped
}

# ---------------------------------------------------------------------------

sub sighup_handler {
  warn "received SIGHUP at ".(scalar localtime time)."\n";
  # this SIGHUP will interrupt a sleep() if one is in progress
  if ($am_parent) { kill(1, $child_pid); } # pass it on
}

# ---------------------------------------------------------------------------

sub sigterm_handler {
  warn "received SIGTERM at ".(scalar localtime time)."\n";
  kill(15, $child_pid);
  if ($pidfile) { unlink($pidfile); }
  die "terminated";
}


