#!/usr/bin/perl -w

use strict;
sub run;

my $perl = $^X;
if (!$perl) {
  die "no perl path found in ARGV!";
}

my $slavename = "generic";

my $pwd = `pwd`;
$pwd =~ /slaves\/([-_A-Za-z0-9]+)\//; if ($1) { $slavename = $1; }

my $targets = "/tmpfs/cor/$1/targets";
print "[using corpus targets file: $targets]\n";

# super-nice please!
#
system ("renice +19 $$");

# cd to masses
#
chdir "masses" or die;

# just the sandbox rules and the timing plugin
#
system ("rm -rf tstrules");
run "mkdir tstrules";
run "cp ../rules/70_sandbox.cf tstrules";
run "cp plugins/*.* tstrules";

# this is run in a chroot jail, just in case there's hostile
# rule code in there...
#
# limit to the most recent 20k messages of each type, as the corpora are
# getting big.
#
run "/local/bbmasstools/masschroot $perl ".
    "mass-check -c=tstrules --tail=20000 --cache --progress -j=1 -f $targets";

exit;

# ---------------------------------------------------------------------------

sub run {
  my ($cmd, $ignoreexit) = @_;

  print "[$cmd]\n";
  system ($cmd);

  if (!$ignoreexit) {
    die "command '$cmd' failed with status $?" if (($? >> 8) != 0);
  }
}

